<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Exploring Multithreading Potential · TraitSimulation.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">TraitSimulation.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../testing_MendelIHT_glm/">Testing Methods</a></li><li><span class="tocitem">Real Data Examples</span><ul><li><a class="tocitem" href="../ukbiobank_vcm_power/">Trait Simulation - Variance Component Model Power (UKBiobank)</a></li><li><a class="tocitem" href="../ukbiobank_ordered_multinomial_power/">Trait Simulation - Ordinal Multinomial Power</a></li></ul></li><li><a class="tocitem" href="../modelspecification/">Alternative Model Specification</a></li><li class="is-active"><a class="tocitem" href>Exploring Multithreading Potential</a><ul class="internal"><li><a class="tocitem" href="#Benchmarking-Results"><span>Benchmarking Results</span></a></li></ul></li><li><a class="tocitem" href="../GPU/">Exploring GPU Potential</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Exploring Multithreading Potential</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Exploring Multithreading Potential</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/OpenMendel/TraitSimulation.jl/blob/master/docs/src/examples/simulate_testing_threads.jl.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="TraitSimulation-explores-Threading-in-Julia:"><a class="docs-heading-anchor" href="#TraitSimulation-explores-Threading-in-Julia:">TraitSimulation explores Threading in Julia:</a><a id="TraitSimulation-explores-Threading-in-Julia:-1"></a><a class="docs-heading-anchor-permalink" href="#TraitSimulation-explores-Threading-in-Julia:" title="Permalink"></a></h1><p>Threading: For users who wish to do multiple simulation runs simultaneously, we recommend to set the machinery to use threading. Users can check using the command: <code>Threads.nthreads()</code> to ensure multi-threading is on. TraitSimulation will automatically use the Threading option for multiple TraitSimulation. To set the number of threads, users should follow the documentation on Threads.jl and ensure before starting Julia to specify the desired number of threads using the following command for 4 threads:      <code>export JULIA_NUM_THREADS=4.</code> </p><p>In this notebook we want to demonstrate the threading capabilites provided by the Julia language, as it applies to TraitSimulation. Users who wish to simulate many traits simultaneously may find this useful. </p><p>It is vital that users are aware of the settings on the machine used to thread the code. For instance, a 4 core machine will be able to specify up to 8 logical cores. But the true performance gain will be from increasing from within the range of the physical cores (1 - 4). We use the <code>BenchmarkTools.jl</code> package to demonstrate the performance gain as we increase the number of physical cores.</p><p>Generate test data:</p><p>We first construct the desired design matrix, regression coefficients, and variance components and covariance matrices for simulation. We will demonstrate the threading results on the following bivariate trait model with <span>$m = 2$</span> variance components, two fixed effects for a sample size of $ n = 1000$ individuals. Each simulation run 1000 times.  </p><div>\[\text{vec}(Y) \sim \text{Normal}(X B, \Sigma_1 \otimes V_1 + \cdots + \Sigma_m \otimes V_m)\]</div><pre><code class="language-julia">using Random, GLM, DataFrames, TraitSimulation
using LinearAlgebra, Distributions, CSV, Plots
using BenchmarkTools

Random.seed!(1234);

n = 1000   # no. observations
I_n = Matrix{Float64}(I, n, n );
d = 2      # dimension of responses
m = 2      # no. variance components
p = 2      # no. covariates

# n-by-p design matrix
X = randn(n, p)

# p-by-d mean component regression coefficient
B = ones(p, d)  

# a tuple of m covariance matrices
V = ntuple(x -&gt; zeros(n, n), m) 

for i = 1:m-1
  V[i]  .= fill(0.1, n, n) .+ 1*Matrix{Float64}(I, n, n) # compound symmetry
end

copy!(V[m], Matrix{Float64}(I, n, n)) # last covarianec matrix is idendity
# a tuple of m d-by-d variance component parameters

Σ = ntuple(x -&gt; zeros(d, d), m) 
for i in 1:m
    Σ[i]  .= fill(0.1, d, d) .+ 0.9.*Matrix{Float64}(I, d, d) # compound symmetry
end

variance_formula = @vc Σ[1] ⊗ V[1] + Σ[2] ⊗ V[2]
vcm_model1 = VCMTrait(X, B, variance_formula)</code></pre><pre><code class="language-none">Variance Component Model
  * number of traits: 2
  * number of variance components: 2
  * sample size: 1000</code></pre><pre><code class="language-julia">function simulate_old_no_threading(trait::Simulation.VCMTrait, n::Integer)
      # pre-allocate output
      Y_n = [zeros(size(trait.μ)) for _ in 1:n] # replicates
      # do the simulation n times, storing each result in a column
      for k in 1:n
          Simulation.simulate!(Y_n[k], trait)
      end
      return Y_n
  end

# this is a function with threading
function simulate_threads(trait::Simulation.VCMTrait, n::Integer)
    # pre-allocate output
    Y_n = [zeros(size(trait.μ)) for _ in 1:n] # replicates
    # do the simulation n times
    Threads.@threads for k in 1:n
        Simulation.simulate!(Y_n[k], trait)
    end
    return Y_n
end
</code></pre><pre><code class="language-none">simulate_threads (generic function with 1 method)</code></pre><pre><code class="language-julia">@benchmark Y = simulate_threads(vcm_model1, 1000)</code></pre><pre><code class="language-none">BenchmarkTools.Trial: 
  memory estimate:  15.39 MiB
  allocs estimate:  1050
  --------------
  minimum time:     1.183 s (0.00% GC)
  median time:      1.353 s (0.00% GC)
  mean time:        1.480 s (0.07% GC)
  maximum time:     2.032 s (0.20% GC)
  --------------
  samples:          4
  evals/sample:     1</code></pre><pre><code class="language-julia">runtime_results = CSV.read(&quot;benchmarking_threading.csv&quot;)</code></pre><h2 id="Benchmarking-Results"><a class="docs-heading-anchor" href="#Benchmarking-Results">Benchmarking Results</a><a id="Benchmarking-Results-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmarking-Results" title="Permalink"></a></h2><pre><code class="language-julia">scatter(xlabel = &quot;Physical CPU Cores&quot;, ylabel = &quot;Milliseconds (ms)&quot;, markersize = 4, label = &quot;median run time&quot;, title = &quot;Multithreading TraitSimulation&quot;, runtime_results[1:12, 1] , runtime_results[1:12, 2], xlims = (0, 13), xticks = 0:1.0:12)</code></pre><p><img src="../median_threading_runtime.png" alt="png"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../modelspecification/">« Alternative Model Specification</a><a class="docs-footer-nextpage" href="../GPU/">Exploring GPU Potential »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Friday 10 July 2020 04:39">Friday 10 July 2020</span>. Using Julia version 1.2.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
