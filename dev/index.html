<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Trait Simulation Tutorial · TraitSimulation.jl</title><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link href="assets/documenter.css" rel="stylesheet" type="text/css"/></head><body><nav class="toc"><h1>TraitSimulation.jl</h1><select id="version-selector" onChange="window.location.href=this.value" style="visibility: hidden"></select><form class="search" id="search-form" action="search/"><input id="search-query" name="q" type="text" placeholder="Search docs"/></form><ul><li class="current"><a class="toctext" href>Trait Simulation Tutorial</a><ul class="internal"><li class="toplevel"><a class="toctext" href="#Add-any-missing-packages-needed-for-this-tutorial:-1">Add any missing packages needed for this tutorial:</a></li><li class="toplevel"><a class="toctext" href="#Reading-the-Mendel-28a-data-using-SnpArrays-1">Reading the Mendel 28a data using SnpArrays</a></li><li class="toplevel"><a class="toctext" href="#Example-1)-Multiple-Independent-Traits:-User-specified-distributions-1">Example 1) Multiple Independent Traits: User specified distributions</a></li><li><a class="toctext" href="#Saving-Simulation-Results-to-Local-Machine-1">Saving Simulation Results to Local Machine</a></li><li class="toplevel"><a class="toctext" href="#Example-2:-Linear-Mixed-Model-(with-additive-genetic-variance-component).-1">Example 2: Linear Mixed Model (with additive genetic variance component).</a></li><li><a class="toctext" href="#The-Variance-Covariance-Matrix-1">The Variance Covariance Matrix</a></li><li><a class="toctext" href="#Example-2b)-Multiple-Correlated-Traits:-(Mendel-Example-28e-Simulation)-1">Example 2b) Multiple Correlated Traits: (Mendel Example 28e Simulation)</a></li><li class="toplevel"><a class="toctext" href="#Generating-Effect-Sizes-1">Generating Effect Sizes</a></li><li><a class="toctext" href="#Function-for-Mean-Model-Expression-1">Function for Mean Model Expression</a></li><li class="toplevel"><a class="toctext" href="#Example-3)-Mixed-effects-model-Single-Trait-and-Rare-Variants:-1">Example 3) Mixed effects model Single Trait and Rare Variants:</a></li><li><a class="toctext" href="#Citations:-1">Citations:</a></li></ul></li></ul></nav><article id="docs"><header><nav><ul><li><a href>Trait Simulation Tutorial</a></li></ul><a class="edit-page" href="https://github.com/sarah-ji/TraitSimulation.jl/blob/master/docs/src/index.md"><span class="fa"></span> Edit on GitHub</a></nav><hr/><div id="topbar"><span>Trait Simulation Tutorial</span><a class="fa fa-bars" href="#"></a></div></header><h1><a class="nav-anchor" id="Trait-Simulation-Tutorial-1" href="#Trait-Simulation-Tutorial-1">Trait Simulation Tutorial</a></h1><p>Authors: Sarah Ji, Janet Sinsheimer, Kenneth Lange</p><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="TraitSimulation.simulate-Tuple{Array{T,1} where T}" href="#TraitSimulation.simulate-Tuple{Array{T,1} where T}"><code>TraitSimulation.simulate</code></a> — <span class="docstring-category">Method</span>.</div><div><div><pre><code class="language-julia">simulate(traits::Vector)</code></pre><p>this for multiple GLM traits</p></div></div><a class="source-link" target="_blank" href="https://github.com/sarah-ji/TraitSimulation.jl/blob/0c264448eb415e97d39d3f8e210046613dea8872/src/TraitSimulation.jl#L43-L48">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="TraitSimulation.simulate-Tuple{GLMTrait}" href="#TraitSimulation.simulate-Tuple{GLMTrait}"><code>TraitSimulation.simulate</code></a> — <span class="docstring-category">Method</span>.</div><div><div><pre><code class="language-julia">simulate(trait::GLMTrait)</code></pre><p>this for GLM trait</p></div></div><a class="source-link" target="_blank" href="https://github.com/sarah-ji/TraitSimulation.jl/blob/0c264448eb415e97d39d3f8e210046613dea8872/src/TraitSimulation.jl#L31-L36">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="TraitSimulation.simulate-Tuple{LMMTrait}" href="#TraitSimulation.simulate-Tuple{LMMTrait}"><code>TraitSimulation.simulate</code></a> — <span class="docstring-category">Method</span>.</div><div><div><pre><code class="language-julia">simulate(trait::LMMTrait)</code></pre><p>this for LMMtrait</p></div></div><a class="source-link" target="_blank" href="https://github.com/sarah-ji/TraitSimulation.jl/blob/0c264448eb415e97d39d3f8e210046613dea8872/src/TraitSimulation.jl#L56-L61">source</a></section><section class="docstring"><div class="docstring-header"><a class="docstring-binding" id="TraitSimulation.vcobjtuple-Tuple{Array{VarianceComponent,1}}" href="#TraitSimulation.vcobjtuple-Tuple{Array{VarianceComponent,1}}"><code>TraitSimulation.vcobjtuple</code></a> — <span class="docstring-category">Method</span>.</div><div><div><p>this is a test for vcobjtuple that is compatible with VarianceComponentModels.jl</p></div></div><a class="source-link" target="_blank" href="https://github.com/sarah-ji/TraitSimulation.jl/blob/0c264448eb415e97d39d3f8e210046613dea8872/src/Multiple_traits.jl#L123-L125">source</a></section><p>In this notebook we show how to use the <code>TraitSimulation.jl</code> package to simulate traits from genotype data from unrelateds or families on user-specified Generalized Linear Models (GLMs) or Linear Mixed Models (LMMs), respectively.</p><p>The data we will be using is from the Mendel version 16[1] sample files. The data is described in examples under Option 28e in the Mendel Version 16 Manual <a href="http://software.genetics.ucla.edu/download?file=202">Section 28.1,  page 279</a>. It consists of simulated data where the two traits of interest have one contributing SNP and a sex effect.</p><p>We use the OpenMendel package <a href="https://openmendel.github.io/SnpArrays.jl/latest/">SnpArrays.jl</a> to read in the PLINK formatted SNP data. In example 2b, we follow Mendel Option 28e with the simulation parameters for Trait1 and Trait2 in Ped28e.out as shown below.</p><p>In both examples, you can specify your own arbitrary fixed effect sizes, variance components and simulation parameters as desired.</p><p>In the <span>$\mathbf{Generating}$</span> <span>$\mathbf{Effect}$</span> <span>$\mathbf{Sizes}$</span> Section of Example 2), we show how the user can generate effect sizes that depend on the minor allele frequencies from a function such as an exponential or chisquare. To aid the user when they wish to include a large number of loci in the model, we created a function that automatically writes out the mean components. </p><div>\[\mathbf{AT}\]</div><p><span>$\mathbf{THE}$</span> <span>$\mathbf{END}$</span> <span>$\mathbf{of}$</span> <span>$\mathbf{Example}$</span> <span>$\mathbf{1}$</span>, we demo how to <span>$\mathbf{write}$</span> <span>$\mathbf{the}$</span> <span>$\mathbf{results}$</span> of each simulation to a file on the users own machine.</p><p>Double check that you are using Julia version 1.0.3 or higher by checking the machine information</p><pre><code class="language-julia">versioninfo()</code></pre><pre><code class="language-none">Julia Version 1.0.3
Commit 099e826241 (2018-12-18 01:34 UTC)
Platform Info:
  OS: macOS (x86_64-apple-darwin14.5.0)
  CPU: Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz
  WORD_SIZE: 64
  LIBM: libopenlibm
  LLVM: libLLVM-6.0.0 (ORCJIT, skylake)</code></pre><h1><a class="nav-anchor" id="Add-any-missing-packages-needed-for-this-tutorial:-1" href="#Add-any-missing-packages-needed-for-this-tutorial:-1">Add any missing packages needed for this tutorial:</a></h1><p>Note: For demonstration purposes, the generation of this Jupyter Notebook requires the use of the following registered packages: <code>DataFrames.jl</code>, <code>SnpArrays.jl</code>, <code>StatsModels.jl</code>, <code>Random.jl</code>, <code>DelimitedFiles.jl</code>, <code>StatsBase.jl</code>, and <code>StatsFuns.jl</code>. </p><p>If it is your first time using these registered packages, you will first have to add the registered packages: DataFrames, SnpArrays, StatsModels, Random, LinearAlgebra, DelimitedFiles, Random, StatsBase by running the following code chunk in Julia&#39;s package manager:</p><pre><code class="language-">pkg&gt; add DataFrames
pkg&gt; add SnpArrays
...
pkg&gt; add StatsFuns</code></pre><p>You can also use the package manager to add the <code>TraitSimulation.jl</code> package by running the following link: &lt;/br&gt;</p><pre><code class="language-">pkg&gt; add &quot;https://github.com/sarah-ji/TraitSimulation.jl&quot;</code></pre><p>Only after all of the necessary packages have been added, load them into your working environment with the <code>using</code> command:</p><pre><code class="language-julia">using DataFrames, SnpArrays, StatsModels, Random, LinearAlgebra, DelimitedFiles, StatsBase, TraitSimulation, StatsFuns</code></pre><p>Reproducibility</p><p>For reproducibility, we set a random seed using the <code>Random.jl</code> package for each simulation using <code>Random.seed!(1234)</code>.  If you wish to end up with different data, you will need to comment out these commands or use another value in Random.seed!().</p><pre><code class="language-julia">Random.seed!(1234);</code></pre><p>The notebook is organized as follows:</p><p>Example 1: Generalized Linear Model In this example we show how to generate single or multiple traits from GLM&#39;s with a genetic variant in the fixed effects, but no residual familial correlation.</p><p>(a) Single Trait:</p><p>In example (1a) we simulate a <span>$\textbf{SINGLE INDEPENDENT NORMAL TRAIT}$</span> (b) Multiple Independent Traits:</p><p>In example (1b) we simulate <span>$\textbf{TWO INDEPENDENT TRAITS SIMULTANEOUSLY}$</span>, one from a Normal distribution and one from a Poisson distribution.</p><p>Example 2: Linear Mixed Model In this example we show how to generate data with the additional additive genetic variance component or residual correlation among relatives. </p><p>For convenience we use the common assumption that the residual covariance among two relatives can be captured by the additive genetic variance times twice the kinship coefficient. However, if you like you can specify your own variance components and their design matrices as long as they are positive semi definite using the <code>@vc</code> macro demonstrated in this example. </p><p>(a) Single Trait:</p><p>In example (2a) we simulate a <span>$\textbf{SINGLE TRAIT CONTROLLING FOR FAMILY STRUCTURE}$</span></p><p>(b) Multiple Correlated Traits: (Mendel Example 28e Simulation)</p><p>We simulate <span>$\textbf{TWO CORRELATED TRAITS CONTROLLING FOR FAMILY STRUCTURE}$</span> with simulation parameters, location = <span>$\mu$</span> and scale = <span>$\Sigma$</span>. </p><p>Example 3: Rare Variant Linear Mixed Model </p><p>The example also assumes an additive genetic variance component in the model which includes 20 rare SNPs, defined as snps with minor allele frequencies greater than 0.002 but less than 0.02.  In practice rare SNPs have smaller minor allele frequencies, but we are limited in this tutorial by the number of individuals in the data set. &lt;br&gt;</p><p>We simulate a Single normal Trait controlling for family structure, with effect sizes generated as a function of the minor allele frequencies.</p><h1><a class="nav-anchor" id="Reading-the-Mendel-28a-data-using-SnpArrays-1" href="#Reading-the-Mendel-28a-data-using-SnpArrays-1">Reading the Mendel 28a data using SnpArrays</a></h1><p>First use <code>SnpArrays.jl</code> to read in the SNP data</p><pre><code class="language-julia">snpdata = SnpArray(&quot;traitsim28e.bed&quot;, 212)</code></pre><pre><code class="language-none">212Ã253141 SnpArray:
 0x03  0x03  0x00  0x03  0x03  0x03     0x02  0x02  0x00  0x00  0x03  0x00
 0x03  0x03  0x00  0x02  0x02  0x03     0x00  0x03  0x00  0x00  0x03  0x00
 0x03  0x03  0x00  0x03  0x03  0x03     0x03  0x02  0x00  0x00  0x03  0x00
 0x03  0x03  0x00  0x03  0x03  0x03     0x02  0x03  0x00  0x00  0x03  0x00
 0x03  0x03  0x00  0x03  0x03  0x03     0x00  0x03  0x00  0x00  0x03  0x00
 0x03  0x03  0x00  0x03  0x03  0x03     0x00  0x00  0x00  0x00  0x00  0x03
 0x03  0x02  0x00  0x03  0x03  0x03     0x02  0x03  0x00  0x03  0x00  0x03
 0x03  0x03  0x00  0x03  0x03  0x03     0x02  0x03  0x00  0x03  0x00  0x03
 0x03  0x02  0x00  0x03  0x03  0x03     0x02  0x02  0x00  0x02  0x00  0x03
 0x03  0x02  0x00  0x03  0x03  0x03     0x03  0x03  0x00  0x03  0x00  0x03
 0x03  0x02  0x00  0x03  0x03  0x03     0x00  0x02  0x00  0x02  0x00  0x03
 0x03  0x03  0x00  0x03  0x03  0x03     0x00  0x02  0x00  0x02  0x00  0x03
 0x03  0x02  0x00  0x03  0x03  0x03     0x02  0x02  0x00  0x02  0x00  0x03
 0x03  0x03  0x00  0x03  0x03  0x03     0x00  0x03  0x00  0x00  0x03  0x00
 0x03  0x03  0x00  0x03  0x03  0x03     0x00  0x03  0x00  0x02  0x02  0x02
 0x03  0x03  0x00  0x03  0x03  0x03     0x00  0x02  0x00  0x00  0x03  0x00
 0x03  0x02  0x00  0x02  0x02  0x03     0x02  0x03  0x00  0x03  0x00  0x03
 0x03  0x03  0x00  0x02  0x02  0x03     0x02  0x03  0x00  0x00  0x03  0x00
 0x03  0x03  0x00  0x03  0x03  0x03     0x02  0x03  0x00  0x02  0x02  0x00
 0x03  0x03  0x00  0x02  0x02  0x03     0x02  0x03  0x00  0x00  0x02  0x02
 0x03  0x03  0x00  0x03  0x03  0x03     0x00  0x03  0x00  0x00  0x03  0x00
 0x03  0x02  0x00  0x03  0x03  0x03     0x02  0x03  0x00  0x00  0x02  0x02
 0x03  0x03  0x00  0x03  0x03  0x03     0x00  0x03  0x00  0x00  0x03  0x00
 0x03  0x03  0x00  0x03  0x03  0x03     0x02  0x03  0x00  0x00  0x03  0x00
 0x03  0x03  0x00  0x03  0x03  0x03     0x00  0x03  0x00  0x02  0x02  0x02</code></pre><p>Store the FamID and PersonID of Individuals in Mendel 28e data</p><pre><code class="language-julia">famfile = readdlm(&quot;traitsim28e.fam&quot;, &#39;,&#39;)
Fam_Person_id = DataFrame(FamID = famfile[:, 1], PID = famfile[:, 2])</code></pre><p>Note: Because later we will want to compare our results to the original results in the file,  we subset <code>traits_original</code> </p><pre><code class="language-julia">traits_original = DataFrame(Trait1 = famfile[:, 7], Trait2 = famfile[:, 8])</code></pre><p>Transform sex variable from M/F to 1/-1 as does Mendel 28e data.  If you prefer you can use the more common convention of making one of the sexes the reference sex (coding it as zero) and make the other sex have the value 1.</p><pre><code class="language-julia">sex = map(x -&gt; strip(x) == &quot;F&quot; ? -1.0 : 1.0, famfile[:, 5]) # note julia&#39;s ternary operator &#39;?&#39;</code></pre><pre><code class="language-none">212-element Array{Float64,1}:
 -1.0
 -1.0
  1.0
  1.0
 -1.0
 -1.0
  1.0
  1.0
 -1.0
  1.0
 -1.0
  1.0
 -1.0
  1.0
  1.0
  1.0
 -1.0
  1.0
  1.0
  1.0
  1.0
  1.0
  1.0
  1.0
  1.0</code></pre><p>Names of Variants:</p><p>We want to find the index of the causal snp, rs10412915, in the snp_definition file and then subset that snp from the genetic marker data above.  We first subset the SNP names into a vector called <code>snpid</code></p><pre><code class="language-julia">snpdef28_1 = readdlm(&quot;traitsim28e.bim&quot;, Any; header = false)
snpid = map(x -&gt; strip(string(x)), snpdef28_1[:, 1]) # strip mining in the data </code></pre><pre><code class="language-none">253141-element Array{SubString{String},1}:
 &quot;rs3020701&quot;  
 &quot;rs56343121&quot; 
 &quot;rs143501051&quot;
 &quot;rs56182540&quot; 
 &quot;rs7260412&quot;  
 &quot;rs11669393&quot; 
 &quot;rs181646587&quot;
 &quot;rs8106297&quot;  
 &quot;rs8106302&quot;  
 &quot;rs183568620&quot;
 &quot;rs186451972&quot;
 &quot;rs189699222&quot;
 &quot;rs182902214&quot;
 â®            
 &quot;rs188169422&quot;
 &quot;rs144587467&quot;
 &quot;rs139879509&quot;
 &quot;rs143250448&quot;
 &quot;rs145384750&quot;
 &quot;rs149215836&quot;
 &quot;rs139221927&quot;
 &quot;rs181848453&quot;
 &quot;rs138318162&quot;
 &quot;rs186913222&quot;
 &quot;rs141816674&quot;
 &quot;rs150801216&quot;</code></pre><p>We first need to find the position of the snp rs10412915.  If you wish to use another snp just change the rs number to another one that is found in the available genotype data, for example rs186913222.</p><pre><code class="language-julia">ind_rs10412915 = findall(x -&gt; x == &quot;rs10412915&quot;, snpid)[1]</code></pre><pre><code class="language-none">236074</code></pre><p>We see that the causal snp, rs10412915, is the 236074th variant in the snp dataset.</p><p>Let&#39;s create a design matrix for the alternative model that includes sex and locus rs10412915.</p><pre><code class="language-julia">locus = convert(Vector{Float64}, @view(snpdata[:, ind_rs10412915]))
X = DataFrame(sex = sex, locus = locus)</code></pre><h1><a class="nav-anchor" id="Example-1)-Multiple-Independent-Traits:-User-specified-distributions-1" href="#Example-1)-Multiple-Independent-Traits:-User-specified-distributions-1">Example 1) Multiple Independent Traits: User specified distributions</a></h1><p>Here I simulate two independent traits simultaneously, one from a Normal distribution and the other from a Poisson Distribution.  We create the following 3 vectors to specify the simulation parameters of the two independent traits: </p><p><code>dist_type_vector</code> <code>link_type_vector</code>  <code>mean_formulas</code></p><pre><code class="language-julia">#for multiple glm traits from different distributions
dist_type_vector = [NormalResponse(4), PoissonResponse()]
link_type_vector = [IdentityLink(), LogLink()]

mean_formulas = [&quot;40 + 3(sex) - 1.5(locus)&quot;, &quot;2 + 2(sex) - 1.5(locus)&quot;]

Multiple_GLM_traits_model_NOTIID = Multiple_GLMTraits(mean_formulas, X, dist_type_vector, link_type_vector)
Simulated_GLM_trait_NOTIID = simulate(Multiple_GLM_traits_model_NOTIID)</code></pre><pre><code class="language-julia">describe(Simulated_GLM_trait_NOTIID, stats = [:mean, :std, :min, :q25, :median, :q75, :max, :eltype])</code></pre><h2><a class="nav-anchor" id="Saving-Simulation-Results-to-Local-Machine-1" href="#Saving-Simulation-Results-to-Local-Machine-1">Saving Simulation Results to Local Machine</a></h2><p>Write the newly simulated trait into a comma separated (csv) file for later use. Note that the user can specify the separator to &#39;\t&#39; for tab separated, or another separator of choice. </p><p>Here we output the simulated traits and covariates for each of the 212 individuals, labeled by their pedigree ID and person ID.</p><pre><code class="language-julia">Trait1_GLM = hcat(Fam_Person_id, Simulated_GLM_trait_NOTIID, X)</code></pre><pre><code class="language-julia">#cd(&quot;/Users&quot;) #change to home directory
CSV.write(&quot;Trait1_GLM.csv&quot;, Trait1_GLM)</code></pre><pre><code class="language-none">&quot;Trait1_GLM.csv&quot;</code></pre><h1><a class="nav-anchor" id="Example-2:-Linear-Mixed-Model-(with-additive-genetic-variance-component).-1" href="#Example-2:-Linear-Mixed-Model-(with-additive-genetic-variance-component).-1">Example 2: Linear Mixed Model (with additive genetic variance component).</a></h1><p>Examples 2a and 2c simulate single traits, while Example 2b simulates two correlated traits.</p><p>We make note that the user can extend the model in Example 2b to include more than 2 variance components using the <code>@vc</code> macro.</p><h2><a class="nav-anchor" id="The-Variance-Covariance-Matrix-1" href="#The-Variance-Covariance-Matrix-1">The Variance Covariance Matrix</a></h2><p>We use the <a href="https://github.com/OpenMendel/SnpArrays.jl">SnpArrays.jl</a> package to find an estimate of the Kinship (<span>$\Phi$</span>), the Genetic Relationship Matrix (GRM). </p><p>We will use the same values of <span>$\mathbf{GRM}$</span>, <span>$V_a$</span>, and <span>$V_e$</span> for both the mixed effect example and for the rare variant example.</p><p>Note that the residual covariance among two relatives is the additive genetic variance, <span>$V_a$</span>, times twice the kinship coefficient, <span>$\Phi$</span>. The kinship matrix is derived from the genetic relationship matrix (GRM) across the common SNPs with minor allele frequency at least 0.05.</p><pre><code class="language-julia">GRM = grm(snpdata, minmaf=0.05)</code></pre><pre><code class="language-none">212x212 Array{Float64,2}:
  0.498264     0.0080878    0.0164327      0.0246825    0.00181856
  0.0080878    0.498054    -0.0212599      -0.0285927   -0.0226525 
  0.0164327   -0.0212599    0.499442       -0.0219661   -0.00748536
  0.253627    -0.00160532   0.282542        0.00612693  -0.00339125
  0.126098     0.253365     0.128931       -0.0158446   -0.00633959
 -0.014971    -0.00266073  -0.00243384     0.00384757   0.0145936 
 -0.0221357    0.0100492   -0.0107012      -0.0148443   -0.00127783
 -0.01629     -0.00749253  -0.015372       -0.0163305   -0.00258392
 -0.016679     0.00353587  -0.0128844      -0.0332489   -0.00707839
 -0.0176101   -0.00996912  -0.0158473      -0.00675875  -0.0122339 
 -0.0162558    0.00938592   0.0064231      -0.00510882   0.0168778 
 -0.0167487    0.00414544  -0.00936538     -0.0134863    0.0020952 
 -0.031148     0.00112387  -0.010794        0.00383105   0.0198635                  
 -0.00865735  -0.00335548  -0.0148433       0.00806601  -0.0211537 
  0.00296028   0.0043655   -0.0183683       0.0012496    0.00898193
 -0.0204601   -0.0270898   -0.00194048     -0.0185883   -0.0116621 
 -0.0174561   -0.0128509   -0.0155773      -0.0274183   -0.0063823 
 -0.00170995   0.0154211   -0.00168146     -0.00684865  -0.0067438 
  0.00718047  -0.00525265  -0.00283975     0.0309601     0.0261103 
 -0.0170218   -0.00661916   0.0020924      -0.022858     0.0037451 
  0.0142551    0.0208073    0.0096287       0.00598877   0.0094809 
 -0.00586031  -0.00733706   0.0339257       0.0109116   -0.0177771 
  0.00299024  -0.0134027    0.0150825       0.00799507   0.0150077 
  0.0246825   -0.0285927   -0.0219661       0.593999     0.0497083 
  0.00181856  -0.0226525   -0.00748536      0.0497083    0.491743</code></pre><pre><code class="language-julia">V_A = [4 1; 1 4]
V_E = [2.0 0.0; 0.0 2.0]
I_n = Matrix{Float64}(I, size(GRM));</code></pre><p>Example 2a: Single Trait </p><p>We simulate a Normal Trait controlling for family structure</p><pre><code class="language-julia">mean_formula = [&quot;40 + 3(sex) - 1.5(locus)&quot;]</code></pre><pre><code class="language-none">1-element Array{String,1}:
 &quot;40 + 3(sex) - 1.5(locus)&quot;</code></pre><pre><code class="language-julia">Ex2a_model = LMMTrait(mean_formula, X, 4*(2*GRM) + 2*(I_n))
trait_2a = simulate(Ex2a_model)</code></pre><pre><code class="language-julia">describe(trait_2a, stats = [:mean, :std, :min, :q25, :median, :q75, :max, :eltype])</code></pre><h2><a class="nav-anchor" id="Example-2b)-Multiple-Correlated-Traits:-(Mendel-Example-28e-Simulation)-1" href="#Example-2b)-Multiple-Correlated-Traits:-(Mendel-Example-28e-Simulation)-1">Example 2b) Multiple Correlated Traits: (Mendel Example 28e Simulation)</a></h2><p>We simulate two correlated Normal Traits controlling for family structure, location = <span>$ÎŒ$</span> and scale = <span>$\mathbf\Sigma$</span>. The corresponding variance covariance matrix as specified Mendel Option 28e, <span>$\mathbf{Î£}$</span>, is generated here.</p><p><span>$FYI$</span>: To create a trait with different variance components change the elements of <span>$\mathbf\Sigma$</span>. We create the variance component object <code>variance_formula</code> below, to simulate our traits in example 2b. While this tutorial only uses 2 variance components, we make note that the <code>@vc</code> macro is designed to handle as many variance components as needed. </p><p>As long as each Variance Component is specified correctly, we can create a <code>VarianceComponent</code> Julia object for Trait Simulation:</p><p>&lt;!– &amp;nbsp;  –&gt; Example) Specifying more than 2 variance components (let V_E3 indicate an additional Environmental Variance component) </p><pre><code class="language-">multiple_variance_formula = @vc kron(V_A , GRM) + kron(V_E1, I_n) + kron(V_E2, I_n) + kron(V_E3, I_n);</code></pre><pre><code class="language-julia"># @vc is a macro that creates a &#39;VarianceComponent&#39; Type for simulation
variance_formula = @vc kron(V_A, GRM) + kron(V_E, I_n);</code></pre><p>These are the formulas for the fixed effects, as specified by Mendel Option 28e.</p><pre><code class="language-julia">mean_formulas = [&quot;40 + 3(sex) - 1.5(locus)&quot;, &quot;20 + 2(sex) - 1.5(locus)&quot;]</code></pre><pre><code class="language-none">2-element Array{String,1}:
 &quot;40 + 3(sex) - 1.5(locus)&quot;
 &quot;20 + 2(sex) - 1.5(locus)&quot;</code></pre><pre><code class="language-julia">Ex2b_model = LMMTrait(mean_formulas, X, variance_formula)
trait_2b = simulate(Ex2b_model)</code></pre><p>Summary Statistics of Our Simulated Traits</p><pre><code class="language-julia">describe(trait_2b, stats = [:mean, :std, :min, :max, :eltype])</code></pre><p>Summary Statistics of the Original Mendel 28e dataset Traits:</p><p>Note we want to see similar values from our simulated traits!</p><pre><code class="language-julia">describe(traits_original, stats = [:mean, :std, :min, :max, :eltype])</code></pre><p>Example 3) Rare Variant Linear Mixed Model with effect sizes as a function of the allele frequencies. </p><p>In this example we first subset only the rare SNP&#39;s with minor allele frequency greater than 0.002 but less than 0.02, then we simulate traits on 20 of the rare SNP&#39;s as fixed effects. For this demo, the indexing <code>snpid[rare_index][1:2:40]</code> allows us to subset every other rare snp in the first 40 SNPs, to get our list of 20 rare SNPs. Change the range and number of SNPs to simulate with more or less SNPs and from different regions of the genome. The number 20 is arbitrary and you can use more or less than 20 if you desire by changing the final number. You can change the spacing of the snps by changing the second number.  For example, <code>snpid[rare_index][1:5:500]</code> would give you 100 snps.</p><p>Here are the 20 SNP&#39;s that will be used for trait simulation in this example.  </p><pre><code class="language-julia"># filter out rare SNPS, get a subset of uncommon SNPs with 0.002 &lt; MAF &lt; 0.02
minor_allele_frequency = maf(snpdata)
rare_index = (0.002 .&lt; minor_allele_frequency &lt; 0.02)
data_rare = snpdata[:, rare_index];</code></pre><pre><code class="language-julia">maf_20_rare_snps = minor_allele_frequency[rare_index][1:2:40]
rare_snps_for_simulation = snpid[rare_index][1:2:40]</code></pre><pre><code class="language-none">20-element Array{SubString{String},1}:
 &quot;rs3020701&quot;  
 &quot;rs181646587&quot;
 &quot;rs182902214&quot;
 &quot;rs184527030&quot;
 &quot;rs10409990&quot; 
 &quot;rs185166611&quot;
 &quot;rs181637538&quot;
 &quot;rs186213888&quot;
 &quot;rs184010370&quot;
 &quot;rs11667161&quot; 
 &quot;rs188819713&quot;
 &quot;rs182378235&quot;
 &quot;rs146361744&quot;
 &quot;rs190575937&quot;
 &quot;rs149949827&quot;
 &quot;rs117671630&quot;
 &quot;rs149171388&quot;
 &quot;rs188520640&quot;
 &quot;rs142722885&quot;
 &quot;rs146938393&quot;</code></pre><h1><a class="nav-anchor" id="Generating-Effect-Sizes-1" href="#Generating-Effect-Sizes-1">Generating Effect Sizes</a></h1><p>In practice rare SNPs have smaller minor allele frequencies but we are limited in this tutorial by the number of individuals in the data set. We use generated effect sizes to evaluate <span>$\mu_{rare20}$</span> on the following Dataframe: &lt;br&gt; </p><pre><code class="language-julia">geno_rare20_converted = convert(DataFrame, convert(Matrix{Float64}, @view(data_rare[:, 1:2:40])))
names!(geno_rare20_converted, Symbol.(rare_snps_for_simulation))</code></pre><p>Chisquared Distribution (df = 1)</p><p>Generating Effect Sizes Based on MAF</p><p>For demonstration purposes, we simulate effect sizes from the Chi-squared(df = 1) distribution, where we use the minor allele frequency (maf) as x and find f(x) where f is the pdf for the Chi-squared (df = 1) density, so that the rarest SNP&#39;s have the biggest effect sizes. The effect sizes are rounded to the second digit, throughout this example. Notice there is a random +1 or -1, so that there are effects that both increase and decrease the simulated trait value.</p><p>In addition to the Chi-Squared distribution, we also demo how to simulate from the Exponential distribution, where we use the minor allele frequency (maf) as x and find f(x) where f is the pdf for the Exponential density.</p><pre><code class="language-julia"># Generating Effect Sizes from Chisquared(df = 1) density
n = length(maf_20_rare_snps)
chisq_coeff = zeros(n)

for i in 1:n
    chisq_coeff[i] = sign(rand() - .5) * chisqpdf(1, maf_20_rare_snps[i])/5.0
end</code></pre><p>Take a look at the simulated coefficients on the left, next to the corresponding minor allele frequency. Notice the rarer SNPs have the largest absolute values for their effect sizes.</p><pre><code class="language-julia">Ex3_rare = round.([chisq_coeff maf_20_rare_snps], digits = 3)
Ex3_rare = DataFrame(Chisq_Coefficient = Ex3_rare[:, 1] , MAF_rare = Ex3_rare[:, 2] )</code></pre><pre><code class="language-julia">simulated_effectsizes_chisq = Ex3_rare[:, 1]</code></pre><pre><code class="language-none">20-element Array{Float64,1}:
 -0.616
 -0.666
 -0.818
 -0.575
  0.818
  1.159
 -0.945
 -0.818
  0.945
 -1.641
 -0.666
  1.159
  1.641
 -1.159
 -0.575
  1.641
  1.641
 -1.641
  0.575
 -1.159</code></pre><p>Exponential Distribution Here we show how to generate effect sizes for the 20 rare snp&#39;s from the Exponential Distribution, where we use the maf as x and find f(x) where f is the pdf for the Exponential density</p><pre><code class="language-julia">simulated_effectsizes_exp = round.(6*exp.(-200*maf_20_rare_snps), digits = 3)</code></pre><pre><code class="language-none">20-element Array{Float64,1}:
 0.221
 0.354
 0.909
 0.138
 0.909
 2.336
 1.457
 0.909
 1.457
 3.744
 0.354
 2.336
 3.744
 2.336
 0.138
 3.744
 3.744
 3.744
 0.138
 2.336</code></pre><h2><a class="nav-anchor" id="Function-for-Mean-Model-Expression-1" href="#Function-for-Mean-Model-Expression-1">Function for Mean Model Expression</a></h2><p>In some cases a large number of variants may be used for simulation. Thus, in this example we create a function where the user inputs a vector of coefficients and a vector of variants for simulation, then the function outputs the mean model expression. </p><p>The function <code>FixedEffectTerms</code>, creates the proper evaluated expression for the simulation process, using the specified vectors of coefficients and snp names. The function outputs <code>evaluated_fixed_expression</code> which will be used to estimate the mean effect, <code>ÎŒ</code> in our mixed effects model. We make use of this function in this example, instead of having to write out all 20 of the coefficients and variant locus names.</p><pre><code class="language-julia">rare_snps_for_simulation</code></pre><pre><code class="language-none">20-element Array{SubString{String},1}:
 &quot;rs3020701&quot;  
 &quot;rs181646587&quot;
 &quot;rs182902214&quot;
 &quot;rs184527030&quot;
 &quot;rs10409990&quot; 
 &quot;rs185166611&quot;
 &quot;rs181637538&quot;
 &quot;rs186213888&quot;
 &quot;rs184010370&quot;
 &quot;rs11667161&quot; 
 &quot;rs188819713&quot;
 &quot;rs182378235&quot;
 &quot;rs146361744&quot;
 &quot;rs190575937&quot;
 &quot;rs149949827&quot;
 &quot;rs117671630&quot;
 &quot;rs149171388&quot;
 &quot;rs188520640&quot;
 &quot;rs142722885&quot;
 &quot;rs146938393&quot;</code></pre><pre><code class="language-julia">function FixedEffectTerms(effectsizes::AbstractVecOrMat, snps::AbstractVecOrMat)
 # implementation
    fixed_terms = &quot;&quot;
for i in 1:length(simulated_effectsizes_chisq) - 1
expression = &quot; + &quot; * string(simulated_effectsizes_chisq[i]) * &quot;(&quot; * rare_snps_for_simulation[i] * &quot;)&quot;
    fixed_terms = fixed_terms * expression
end
    return String(fixed_terms)
end
</code></pre><pre><code class="language-none">FixedEffectTerms (generic function with 1 method)</code></pre><pre><code class="language-julia">mean_formula_rare = FixedEffectTerms(simulated_effectsizes_chisq, rare_snps_for_simulation)</code></pre><pre><code class="language-none">&quot; + -0.616(rs3020701) + -0.666(rs181646587) + -0.818(rs182902214) + -0.575(rs184527030) + 0.818(rs10409990) + 1.159(rs185166611) + -0.945(rs181637538) + -0.818(rs186213888) + 0.945(rs184010370) + -1.641(rs11667161) + -0.666(rs188819713) + 1.159(rs182378235) + 1.641(rs146361744) + -1.159(rs190575937) + -0.575(rs149949827) + 1.641(rs117671630) + 1.641(rs149171388) + -1.641(rs188520640) + 0.575(rs142722885)&quot;</code></pre><h1><a class="nav-anchor" id="Example-3)-Mixed-effects-model-Single-Trait-and-Rare-Variants:-1" href="#Example-3)-Mixed-effects-model-Single-Trait-and-Rare-Variants:-1">Example 3) Mixed effects model Single Trait and Rare Variants:</a></h1><pre><code class="language-julia">rare_20_snp_model = LMMTrait([mean_formula_rare], geno_rare20_converted, 4*(2*GRM) + 2*(I_n))
trait_rare_20_snps = simulate(rare_20_snp_model)</code></pre><pre><code class="language-julia">describe(trait_rare_20_snps, stats = [:mean, :std, :min, :max, :eltype])</code></pre><p>Saving Simulation Results to Local Machine</p><p>Here we output the simulated trait values for each of the 212 individuals, labeled by their pedigree ID and person ID.</p><p>In addition, we output the genotypes for the variants used to simulate this trait.</p><pre><code class="language-julia">Trait3_mixed = hcat(Fam_Person_id, trait_rare_20_snps, geno_rare20_converted)</code></pre><pre><code class="language-julia">Coefficients = DataFrame(Coefficients = simulated_effectsizes_chisq)
SNPs_rare = DataFrame(SNPs = rare_snps_for_simulation)
Trait3_mixed_sim = hcat(Coefficients, SNPs_rare)</code></pre><pre><code class="language-julia">#cd(&quot;/Users&quot;) #change to home directory
using CSV
CSV.write(&quot;Trait3_mixed.csv&quot;, Trait3_mixed)
CSV.write(&quot;Trait3_mixed_sim.csv&quot;, Trait3_mixed_sim);</code></pre><h2><a class="nav-anchor" id="Citations:-1" href="#Citations:-1">Citations:</a></h2><p>[1] Lange K, Papp JC, Sinsheimer JS, Sripracha R, Zhou H, Sobel EM (2013) Mendel: The Swiss army knife of genetic analysis programs. Bioinformatics 29:1568-1570.`</p><p>[2] OPENMENDEL: a cooperative programming project for statistical genetics. <a href="https://www.ncbi.nlm.nih.gov/pubmed/?term=OPENMENDEL">Hum Genet. 2019 Mar 26. doi: 10.1007/s00439-019-02001-z</a>.</p><p>&lt;!– ## Table of Contents</p><ul><li><a href="#Trait-Simulation-Tutorial-1">Trait Simulation Tutorial</a></li><li><a href="#Add-any-missing-packages-needed-for-this-tutorial:-1">Add any missing packages needed for this tutorial:</a></li><li><a href="#Reading-the-Mendel-28a-data-using-SnpArrays-1">Reading the Mendel 28a data using SnpArrays</a></li><li><a href="#Example-1)-Multiple-Independent-Traits:-User-specified-distributions-1">Example 1) Multiple Independent Traits: User specified distributions</a></li><ul><li><a href="#Saving-Simulation-Results-to-Local-Machine-1">Saving Simulation Results to Local Machine</a></li></ul><li><a href="#Example-2:-Linear-Mixed-Model-(with-additive-genetic-variance-component).-1">Example 2: Linear Mixed Model (with additive genetic variance component).</a></li><ul><li><a href="#The-Variance-Covariance-Matrix-1">The Variance Covariance Matrix</a></li><li><a href="#Example-2b)-Multiple-Correlated-Traits:-(Mendel-Example-28e-Simulation)-1">Example 2b) Multiple Correlated Traits: (Mendel Example 28e Simulation)</a></li></ul><li><a href="#Generating-Effect-Sizes-1">Generating Effect Sizes</a></li><ul><li><a href="#Function-for-Mean-Model-Expression-1">Function for Mean Model Expression</a></li></ul><li><a href="#Example-3)-Mixed-effects-model-Single-Trait-and-Rare-Variants:-1">Example 3) Mixed effects model Single Trait and Rare Variants:</a></li><ul><li><a href="#Citations:-1">Citations:</a></li></ul></ul><p>–&gt;</p><footer><hr/></footer></article></body></html>
